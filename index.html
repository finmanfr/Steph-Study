<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Basketball Flashcards ‚Äî Study</title>
<style>
  :root{
    --blue:#0A66C2;
    --blue-dark:#084c8d;
    --yellow:#FFD83B;
    --bg:#f4f6fb;
    --card:#ffffff;
    --muted:#6b7280;
    --success:#28a745;
    --danger:#dc3545;
    --radius:14px;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:linear-gradient(180deg,var(--bg), #ffffff);
    color:#0b2540;
    -webkit-font-smoothing:antialiased;
  }

  /* Layout */
  .app {
    display:flex;
    min-height:100vh;
  }
  .sidebar {
    width:260px;
    background:var(--blue);
    color:white;
    padding:28px 20px;
    display:flex;
    flex-direction:column;
    gap:14px;
    align-items:center;
  }
  .logo {
    font-weight:800;
    font-size:20px;
    letter-spacing:0.6px;
    display:flex;
    gap:10px;
    align-items:center;
  }
  .logo .ball { font-size:20px; transform:translateY(-1px) }

  .btn {
    width:100%;
    padding:12px 14px;
    border-radius:10px;
    border:none;
    font-weight:600;
    cursor:pointer;
    font-size:15px;
  }
  .btn.create { background:var(--yellow); color: #0b2540; }
  .btn.ghost { background:transparent; color: white; border:1px solid rgba(255,255,255,0.12) }
  .btn.full {background:var(--blue-dark); color:white}

  .sidebar .small { font-size:13px; opacity:0.9 }

  /* Main content */
  .main {
    flex:1;
    padding:28px;
    margin-left:0;
  }

  header.main-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:18px;
  }
  .header-left h1{ margin:0; color:var(--blue); font-size:26px; }
  .header-left p{ margin:4px 0 0; color:var(--muted); font-size:13px }

  .controls { display:flex; gap:12px; align-items:center; }

  /* Folder grid */
  .folder-grid { display:flex; flex-wrap:wrap; gap:18px; margin-top:18px; }
  .folder-card{
    width:210px;
    border-radius:12px;
    padding:18px;
    background:var(--card);
    box-shadow: 0 6px 18px rgba(9,30,66,0.06);
    cursor:pointer;
    transition:transform .15s ease, box-shadow .15s;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .folder-card:hover { transform:translateY(-6px); box-shadow:0 18px 32px rgba(9,30,66,0.08) }
  .folder-icon { font-size:34px; color:var(--blue) }
  .folder-name { font-weight:700; color:#092240 }
  .folder-meta { color:var(--muted); font-size:13px }

  /* Folder view */
  .folder-view {
    display:flex;
    gap:20px;
    margin-top:16px;
  }
  .left {
    width:420px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .card-list {
    display:flex;
    flex-direction:column;
    gap:12px;
    max-height:70vh;
    overflow:auto;
    padding-right:8px;
  }
  .card-row {
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:center;
    padding:12px;
    border-radius:10px;
    background:var(--card);
    box-shadow: 0 6px 14px rgba(9,30,66,0.04);
  }
  .term { font-weight:700; color:var(--blue-dark) }
  .def { color:var(--muted); font-size:14px; max-width:240px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }

  .card-actions { display:flex; gap:8px; align-items:center }
  .icon-btn { border:none; background:transparent; cursor:pointer; font-size:16px; padding:8px; border-radius:8px }
  .icon-btn:hover { background:rgba(9,30,66,0.04) }

  /* Study area */
  .study-area {
    flex:1;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:16px;
    justify-content:flex-start;
    padding-top:40px;
  }

  .big-card {
    width:540px;
    height:320px;
    border-radius:var(--radius);
    background:var(--card);
    box-shadow: 0 18px 36px rgba(9,30,66,0.08);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:28px;
    padding:24px;
    perspective:1000px;
    cursor:pointer;
    position:relative;
  }

  .inner {
    width:100%;
    height:100%;
    border-radius:var(--radius);
    transition:transform .7s;
    transform-style:preserve-3d;
    position:relative;
  }
  .big-card.flip .inner { transform:rotateY(180deg) }

  .face {
    position:absolute;
    inset:0;
    backface-visibility:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:28px;
    border-radius:var(--radius);
    box-sizing:border-box;
    text-align:center;
  }
  .front { color:var(--blue-dark); font-weight:700; }
  .back {
    transform:rotateY(180deg);
    background:var(--blue);
    color:white;
    font-weight:600;
  }

  .study-controls { display:flex; gap:10px; align-items:center; margin-top:6px }
  .know { background:var(--success); color:white; padding:12px 18px; border-radius:10px; border:none; cursor:pointer }
  .dont { background:var(--danger); color:white; padding:12px 18px; border-radius:10px; border:none; cursor:pointer }
  .mode-toggle { background:transparent; border:1px solid rgba(9,30,66,0.08); padding:8px 10px; border-radius:8px; cursor:pointer }

  /* Test mode */
  .test-area { width:640px; background:var(--card); border-radius:12px; padding:18px; box-shadow:0 12px 28px rgba(9,30,66,0.06) }
  .mc-question { font-size:20px; margin-bottom:12px }
  .mc-options { display:flex; flex-direction:column; gap:8px }
  .mc-option { padding:12px 14px; border-radius:10px; border:1px solid #e6e9f2; cursor:pointer; background:white }
  .mc-option.correct { background:linear-gradient(90deg, rgba(40,167,69,0.12), rgba(40,167,69,0.06)); border-color:#c1f0d0 }
  .mc-option.incorrect { background:linear-gradient(90deg, rgba(220,53,69,0.08), rgba(220,53,69,0.03)); border-color:#f2c7c9 }

  /* small */
  .muted { color:var(--muted) }
  .toolbar { display:flex; gap:10px; align-items:center }
  .search { padding:10px; border-radius:8px; border:1px solid #e6e9f2 }

  /* modal */
  .modal {
    position:fixed; inset:0; display:none; place-items:center; background:rgba(7,14,28,0.36); z-index:50;
  }
  .modal.open { display:grid }
  .modal-box {
    width:520px; background:white; border-radius:12px; padding:18px; box-shadow:0 30px 80px rgba(9,30,66,0.2)
  }
  .row { display:flex; gap:10px; align-items:center }
  .small-muted { font-size:13px; color:var(--muted) }
</style>
</head>
<body>

<div class="app">
  <aside class="sidebar">
    <div class="logo"><span class="ball">üèÄ</span> HoopCards</div>
    <div class="small muted">Study smarter ‚Äî local only</div>

    <button class="btn create" onclick="openCreateModal()">+ New Folder</button>
    <button class="btn ghost" onclick="renderFolderList()">Folders</button>

    <div style="flex:1"></div>

    <div style="width:100%; display:flex; gap:8px; flex-direction:column; align-items:center">
      <button class="btn full" onclick="toggleTheme()">Toggle Theme</button>
      <div class="small-muted" style="font-size:12px;margin-top:6px">Saved in browser (localStorage)</div>
    </div>
  </aside>

  <main class="main">
    <header class="main-header">
      <div class="header-left">
        <h1>HoopCards</h1>
        <p class="muted">Blue + yellow theme ‚Äî flip, sort, test, edit & delete</p>
      </div>

      <div class="controls">
        <input id="search" class="search" placeholder="Search folders or cards..." oninput="applySearch()" />
      </div>
    </header>

    <!-- FOLDER GRID -->
    <section id="grid" >
      <div class="folder-grid" id="folderGrid"></div>
    </section>

    <!-- FOLDER VIEW (hidden until open) -->
    <section id="folderSection" style="display:none">
      <div class="folder-view">
        <div class="left">
          <div style="display:flex; justify-content:space-between; align-items:center">
            <div>
              <div style="font-weight:700; font-size:18px" id="folderTitleLabel"></div>
              <div class="muted" id="folderCountLabel"></div>
            </div>
            <div>
              <button class="icon-btn" title="Edit folder" onclick="openEditFolderModal()">
                ‚úèÔ∏è
              </button>
              <button class="icon-btn" title="Delete folder" onclick="deleteFolderConfirm()">
                üóëÔ∏è
              </button>
            </div>
          </div>

          <div style="margin-top:12px; display:flex; gap:8px">
            <button class="btn full" onclick="openAddCardModal()">+ Add Card</button>
            <button class="btn" style="background:var(--yellow); color:var(--blue); font-weight:700" onclick="openBulkModal()">Bulk Add</button>
            <button class="btn" onclick="startStudyMode('regular')">Study (Flip)</button>
            <button class="btn" onclick="startStudyMode('sorting')">Study (Sort)</button>
            <button class="btn" onclick="startTestMode()">Test (Multiple choice)</button>
          </div>

          <div style="margin-top:14px">
            <div class="card-list" id="cardList"></div>
          </div>
        </div>

        <div class="study-area" id="studyArea" style="width:100%">
          <!-- placeholder -->
          <div style="text-align:center; color:var(--muted); margin-top:40px">Open a folder and choose Study or Test to begin</div>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- Modals -->
<div id="modal" class="modal">
  <div class="modal-box" id="modalBox"></div>
</div>

<script>
/* ---------- Data Layer ---------- */
let data = JSON.parse(localStorage.getItem('hoop_folders') || '{}');
// structure: { folderName: [ {term, def, id}, ... ] }
function saveData(){ localStorage.setItem('hoop_folders', JSON.stringify(data)); }

/* ---------- Utilities ---------- */
function uid(){ return Math.random().toString(36).slice(2,10) }
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)) }

/* ---------- Rendering folders ---------- */
const folderGrid = document.getElementById('folderGrid');
const folderSection = document.getElementById('folderSection');
const folderTitleLabel = document.getElementById('folderTitleLabel');
const folderCountLabel = document.getElementById('folderCountLabel');
const cardList = document.getElementById('cardList');
const studyArea = document.getElementById('studyArea');
let currentFolder = null;

/* initial render */
renderFolderList();

function renderFolderList(filter=''){
  folderSection.style.display='none';
  document.getElementById('grid').style.display='block';
  folderGrid.innerHTML='';
  const names = Object.keys(data).filter(n => n.toLowerCase().includes(filter.toLowerCase()));
  if(names.length===0){
    folderGrid.innerHTML = `<div style="color:var(--muted); padding:20px;">No folders ‚Äî create one.</div>`;
    return;
  }
  names.forEach(name => {
    const el = document.createElement('div');
    el.className='folder-card';
    el.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center">
        <div style="display:flex; gap:12px; align-items:center">
          <div class="folder-icon">üìÅ</div>
          <div>
            <div class="folder-name">${escapeHtml(name)}</div>
            <div class="folder-meta">${data[name].length} cards</div>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button title="Open" class="icon-btn" onclick="openFolder('${encodeURIComponent(name)}')">‚ñ∂Ô∏è</button>
        </div>
      </div>`;
    folderGrid.appendChild(el);
  });
}

/* ---------- Open folder ---------- */
function openFolder(encodedName){
  const name = decodeURIComponent(encodedName);
  currentFolder = name;
  document.getElementById('grid').style.display='none';
  folderSection.style.display='block';
  folderTitleLabel.textContent = name;
  folderCountLabel.textContent = `${data[name].length} cards`;
  renderCardList();
  studyArea.innerHTML = `<div style="text-align:center; color:var(--muted); margin-top:40px">Choose Study or Test to begin</div>`;
}

/* ---------- Card List render ---------- */
function renderCardList(){
  cardList.innerHTML='';
  const arr = data[currentFolder] || [];
  if(arr.length===0){
    cardList.innerHTML = `<div style="color:var(--muted); padding:10px">No cards ‚Äî add one or bulk add.</div>`;
    return;
  }
  arr.forEach(card => {
    const row = document.createElement('div');
    row.className='card-row';
    row.innerHTML = `<div>
        <div class="term">${escapeHtml(card.term)}</div>
        <div class="def">${escapeHtml(card.def)}</div>
      </div>
      <div class="card-actions">
        <button class="icon-btn" title="Edit" onclick="openEditCardModal('${card.id}')">‚úèÔ∏è</button>
        <button class="icon-btn" title="Delete" onclick="deleteCardConfirm('${card.id}')">üóëÔ∏è</button>
      </div>`;
    cardList.appendChild(row);
  });
}

/* ---------- Create / Edit Folder & Card Modals ---------- */
const modal = document.getElementById('modal');
const modalBox = document.getElementById('modalBox');

function openCreateModal(){
  modalBox.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center">
      <h3 style="margin:0">Create Folder</h3>
      <button onclick="closeModal()" class="icon-btn">‚úñÔ∏è</button>
    </div>
    <div style="margin-top:12px">
      <input id="newFolderName" placeholder="Folder name" />
      <textarea id="newBulk" style="height:120px; margin-top:8px" placeholder="Bulk add (term - definition per line)"></textarea>
      <div style="display:flex; gap:8px; margin-top:8px">
        <button class="save-btn" onclick="createFolder()">Create</button>
        <button class="btn" onclick="closeModal()">Cancel</button>
      </div>
    </div>`;
  modal.classList.add('open');
}

function openBulkModal(){
  modalBox.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center">
      <h3 style="margin:0">Bulk Add to "${escapeHtml(currentFolder)}"</h3>
      <button onclick="closeModal()" class="icon-btn">‚úñÔ∏è</button>
    </div>
    <div style="margin-top:12px">
      <textarea id="bulkToFolder" style="height:160px" placeholder="term - definition per line"></textarea>
      <div style="display:flex; gap:8px; margin-top:8px">
        <button class="save-btn" onclick="bulkAddToCurrent()">Add</button>
        <button class="btn" onclick="closeModal()">Cancel</button>
      </div>
    </div>`;
  modal.classList.add('open');
}

function openAddCardModal(){
  modalBox.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center">
      <h3 style="margin:0">Add Card to "${escapeHtml(currentFolder)}"</h3>
      <button onclick="closeModal()" class="icon-btn">‚úñÔ∏è</button>
    </div>
    <div style="margin-top:12px">
      <input id="addTerm" placeholder="Term" />
      <textarea id="addDef" style="height:110px" placeholder="Definition"></textarea>
      <div style="display:flex; gap:8px; margin-top:8px">
        <button class="save-btn" onclick="addCard()">Add Card</button>
        <button class="btn" onclick="closeModal()">Cancel</button>
      </div>
    </div>`;
  modal.classList.add('open');
}

function openEditFolderModal(){
  modalBox.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center">
      <h3 style="margin:0">Rename Folder</h3>
      <button onclick="closeModal()" class="icon-btn">‚úñÔ∏è</button>
    </div>
    <div style="margin-top:12px">
      <input id="renameField" value="${escapeHtml(currentFolder)}" />
      <div style="display:flex; gap:8px; margin-top:8px">
        <button class="save-btn" onclick="renameFolder()">Save</button>
        <button class="btn" onclick="closeModal()">Cancel</button>
      </div>
    </div>`;
  modal.classList.add('open');
}

function openEditCardModal(cardId){
  const card = (data[currentFolder]||[]).find(c=>c.id===cardId);
  if(!card) return alert('Card not found');
  modalBox.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center">
      <h3 style="margin:0">Edit Card</h3>
      <button onclick="closeModal()" class="icon-btn">‚úñÔ∏è</button>
    </div>
    <div style="margin-top:12px">
      <input id="editTerm" value="${escapeHtml(card.term)}" />
      <textarea id="editDef" style="height:110px">${escapeHtml(card.def)}</textarea>
      <div style="display:flex; gap:8px; margin-top:8px">
        <button class="save-btn" onclick="saveEditedCard('${cardId}')">Save</button>
        <button class="btn" onclick="closeModal()">Cancel</button>
      </div>
    </div>`;
  modal.classList.add('open');
}

function closeModal(){ modal.classList.remove('open'); modalBox.innerHTML=''; }

/* ---------- Folder & card CRUD ---------- */
function createFolder(){
  const name = document.getElementById('newFolderName').value.trim();
  if(!name) return alert('Folder name required');
  if(data[name]) return alert('Folder exists');
  data[name]=[];
  const bulk = document.getElementById('newBulk').value.trim();
  if(bulk) {
    const lines = bulk.split('\n');
    lines.forEach(line=>{
      if(!line.includes('-')) return;
      const parts = line.split('-');
      const term = parts.shift().trim();
      const def = parts.join('-').trim();
      if(term && def) data[name].push({id:uid(), term, def});
    });
  }
  saveData();
  closeModal();
  renderFolderList();
}

function addCard(){
  const term = document.getElementById('addTerm').value.trim();
  const def = document.getElementById('addDef').value.trim();
  if(!term || !def) return alert('Enter term and definition');
  data[currentFolder].push({id:uid(), term, def});
  saveData();
  closeModal();
  renderCardList();
  folderCountLabel.textContent = `${data[currentFolder].length} cards`;
}

function bulkAddToCurrent(){
  const txt = document.getElementById('bulkToFolder').value.trim();
  if(!txt) return alert('Bulk text required');
  const lines = txt.split('\n');
  lines.forEach(line=>{
    if(!line.includes('-')) return;
    const parts = line.split('-');
    const term = parts.shift().trim();
    const def = parts.join('-').trim();
    if(term && def) data[currentFolder].push({id:uid(), term, def});
  });
  saveData();
  closeModal();
  renderCardList();
  folderCountLabel.textContent = `${data[currentFolder].length} cards`;
}

function renameFolder(){
  const newName = document.getElementById('renameField').value.trim();
  if(!newName) return alert('Name required');
  if(newName===currentFolder) { closeModal(); return; }
  if(data[newName]) return alert('A folder with that name already exists');
  data[newName] = data[currentFolder];
  delete data[currentFolder];
  saveData();
  currentFolder = newName;
  closeModal();
  openFolder(encodeURIComponent(newName));
}

function deleteFolderConfirm(){
  if(!confirm(`Delete folder "${currentFolder}"? This cannot be undone.`)) return;
  delete data[currentFolder];
  saveData();
  currentFolder = null;
  renderFolderList();
}

function deleteCardConfirm(cardId){
  if(!confirm('Delete this card?')) return;
  data[currentFolder] = data[currentFolder].filter(c=>c.id!==cardId);
  saveData();
  renderCardList();
  folderCountLabel.textContent = `${data[currentFolder].length} cards`;
}

function saveEditedCard(cardId){
  const term = document.getElementById('editTerm').value.trim();
  const def = document.getElementById('editDef').value.trim();
  if(!term || !def) return alert('Enter both fields');
  const idx = data[currentFolder].findIndex(c=>c.id===cardId);
  if(idx>=0){
    data[currentFolder][idx].term = term;
    data[currentFolder][idx].def = def;
    saveData();
    closeModal();
    renderCardList();
  }
}

/* ---------- Search ---------- */
function applySearch(){
  const q = document.getElementById('search').value.trim();
  if(folderSection.style.display==='block') {
    // search within current folder cards
    const arr = (data[currentFolder]||[]).filter(c => c.term.toLowerCase().includes(q.toLowerCase()) || c.def.toLowerCase().includes(q.toLowerCase()));
    cardList.innerHTML='';
    if(arr.length===0) cardList.innerHTML=`<div style="color:var(--muted); padding:10px">No cards matching.</div>`;
    arr.forEach(c=>{
      const row = document.createElement('div');
      row.className='card-row';
      row.innerHTML = `<div>
          <div class="term">${escapeHtml(c.term)}</div>
          <div class="def">${escapeHtml(c.def)}</div>
        </div>
        <div class="card-actions">
          <button class="icon-btn" title="Edit" onclick="openEditCardModal('${c.id}')">‚úèÔ∏è</button>
          <button class="icon-btn" title="Delete" onclick="deleteCardConfirm('${c.id}')">üóëÔ∏è</button>
        </div>`;
      cardList.appendChild(row);
    });
  } else {
    renderFolderList(q);
  }
}

/* ---------- Study Modes ---------- */
let studyState = null; // { mode: 'regular'|'sorting', queue:[], index, known:[], unknown:[] }
function startStudyMode(mode){
  if(!currentFolder) return alert('Open a folder first');
  const pool = data[currentFolder].map(c=>({...c})); // clone
  if(pool.length===0) return alert('Folder has no cards');
  studyState = { mode, queue:shuffle(pool), index:0, known:[], unknown:[] };
  renderStudyUI();
}

function renderStudyUI(){
  // top area: big card
  studyArea.innerHTML = `
    <div style="display:flex; justify-content:space-between; width:100%; max-width:760px; align-items:center">
      <div><strong>${escapeHtml(currentFolder)}</strong> ‚Äî <span class="muted">${studyState.queue.length} cards</span></div>
      <div class="toolbar">
        <div class="muted">Mode: <strong>${studyState.mode}</strong></div>
        <div style="width:12px"></div>
        <button class="mode-toggle" onclick="endStudy()">End</button>
      </div>
    </div>
    <div class="big-card" id="bigCard" onclick="flipStudyCard()">
      <div class="inner" id="innerCard">
        <div class="face front" id="studyFront"></div>
        <div class="face back" id="studyBack"></div>
      </div>
    </div>
    <div style="display:flex; gap:12px; align-items:center">
      <button class="know" onclick="markKnow()">Know</button>
      <button class="dont" onclick="markDont()">Don't Know</button>
      <div style="margin-left:12px" id="progressLabel"></div>
    </div>
  `;
  updateStudyCard();
}

function updateStudyCard(){
  if(!studyState) return;
  if(studyState.index >= studyState.queue.length){
    // finished
    studyArea.innerHTML = `<div style="text-align:center; max-width:760px">
      <h2>Session Complete</h2>
      <p class="muted">${studyState.known.length} known ‚Äî ${studyState.unknown.length} didn't know (re-queued)</p>
      <div style="display:flex; gap:10px; justify-content:center; margin-top:12px">
        <button class="save-btn" onclick="endStudy()">Close</button>
      </div>
    </div>`;
    return;
  }
  const card = studyState.queue[studyState.index];
  document.getElementById('studyFront').textContent = card.term;
  document.getElementById('studyBack').textContent = card.def;
  document.getElementById('progressLabel').textContent = `Card ${studyState.index+1} / ${studyState.queue.length}`;
  // reset flip
  document.getElementById('bigCard').classList.remove('flip');
}

function flipStudyCard(){
  const el = document.getElementById('bigCard');
  el.classList.toggle('flip');
}

function markKnow(){
  if(!studyState) return;
  const card = studyState.queue[studyState.index];
  studyState.known.push(card);
  studyState.index++;
  updateStudyCard();
}

function markDont(){
  if(!studyState) return;
  const card = studyState.queue[studyState.index];
  studyState.unknown.push(card);
  // re-queue to end
  studyState.queue.push(card);
  studyState.index++;
  updateStudyCard();
}

function endStudy(){
  studyState = null;
  studyArea.innerHTML = `<div style="text-align:center; color:var(--muted); margin-top:40px">Choose Study or Test to begin</div>`;
}

/* ---------- Test Mode (Multiple Choice) ---------- */
let testState = null;
// start
function startTestMode(){
  if(!currentFolder) return alert('Open a folder first');
  const pool = data[currentFolder].slice();
  if(pool.length < 2) return alert('Need at least 2 cards for test mode (to create distractors).');
  testState = { pool:shuffle(pool), index:0, score:0, total: Math.min(10, pool.length) };
  renderTestUI();
}

function renderTestUI(){
  if(!testState) return;
  studyArea.innerHTML = `
    <div style="width:100%; max-width:760px; display:flex; justify-content:space-between; align-items:center">
      <div><strong>Test: ${escapeHtml(currentFolder)}</strong> ‚Äî Question ${testState.index+1}/${testState.total}</div>
      <div><button class="mode-toggle" onclick="endTest()">End Test</button></div>
    </div>
    <div class="test-area" id="testArea"></div>
  `;
  showTestQuestion();
}

function showTestQuestion(){
  const idx = testState.index;
  if(idx >= testState.total){
    // show results
    studyArea.innerHTML = `<div style="text-align:center; max-width:760px">
      <h2>Test Complete</h2>
      <p class="muted">Score: ${testState.score} / ${testState.total}</p>
      <div style="display:flex; gap:10px; justify-content:center; margin-top:12px">
        <button class="save-btn" onclick="endTest()">Close</button>
      </div>
    </div>`;
    return;
  }
  // pick question card
  const question = testState.pool[idx];
  // choose 3 distractors
  const others = data[currentFolder].filter(c=>c.id !== question.id);
  const distractors = shuffle(others).slice(0,3).map(d=>d.def);
  const options = shuffle([question.def, ...distractors]);

  const testArea = document.getElementById('testArea');
  testArea.innerHTML = `
    <div class="mc-question">What is the definition of:<br><strong style="font-size:20px">${escapeHtml(question.term)}</strong></div>
    <div class="mc-options">
      ${options.map((opt,i)=>`<div class="mc-option" onclick="chooseOption(${i})" data-answer="${escapeHtml(opt)}">${escapeHtml(opt)}</div>`).join('')}
    </div>
  `;
  // store current options & correct
  testState.currentCorrect = question.def;
  testState.currentOptions = options;
}

function chooseOption(i){
  const selected = testState.currentOptions[i];
  const area = document.querySelectorAll('.mc-option');
  // mark selected and reveal correct
  area.forEach(el=>{
    const v = el.getAttribute('data-answer');
    if(v === testState.currentCorrect) el.classList.add('correct');
    if(v === selected && v !== testState.currentCorrect) el.classList.add('incorrect');
    el.style.pointerEvents='none';
  });
  if(selected === testState.currentCorrect) testState.score++;
  // next after short delay
  setTimeout(()=>{ testState.index++; showTestQuestion(); }, 800);
}

function endTest(){
  testState = null;
  studyArea.innerHTML = `<div style="text-align:center; color:var(--muted); margin-top:40px">Choose Study or Test to begin</div>`;
}

/* ---------- Helpers ---------- */
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function escapeHtml(str){
  return String(str||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
}

/* ---------- small utilities ---------- */
function deleteAllData(){
  if(confirm('Delete all folders?')){ data={}; saveData(); renderFolderList(); alert('All deleted'); }
}

/* ---------- UI extras ---------- */
function toggleTheme(){ document.body.classList.toggle('alt-theme'); alert('Theme toggle (placeholder).') }

/* ---------- Init sample data if none ---------- */
if(Object.keys(data).length===0){
  data['Sample: Basketball Terms'] = [
    {id:uid(), term:'Dribble', def:'Bounce the ball while moving.'},
    {id:uid(), term:'Assist', def:'A pass that leads directly to a score.'},
    {id:uid(), term:'Rebound', def:'Retrieve the ball after a missed shot.'},
    {id:uid(), term:'Layup', def:'Close-range shot off the backboard.'}
  ];
  saveData();
  renderFolderList();
}

/* ---------- Safety note: clicking outside modal closes it ---------- */
modal.addEventListener('click', (e)=>{
  if(e.target === modal) closeModal();
});

</script>
</body>
</html>
