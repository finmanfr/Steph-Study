<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Steph Study</title>
<style>
  :root{
    --blue:#0A66C2;
    --blue-dark:#084c8d;
    --yellow:#FFD83B;
    --bg:#f4f6fb;
    --card:#ffffff;
    --muted:#6b7280;
    --success:#28a745;
    --danger:#dc3545;
    --radius:14px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    background:linear-gradient(180deg,var(--bg),#ffffff);
    color:#0b2540;
    -webkit-font-smoothing:antialiased;
  }
  .app{display:flex;min-height:100vh}
  aside.sidebar{
    width:260px;background:var(--blue);color:white;padding:22px;display:flex;flex-direction:column;gap:12px;
  }
  .logo{font-weight:800;font-size:18px;display:flex;gap:10px;align-items:center}
  .logo .ball{font-size:22px}
  .small{font-size:13px;color:rgba(255,255,255,0.9)}
  .btn{width:100%;padding:12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .btn.create{background:var(--yellow);color:#022442}
  .btn.ghost{background:transparent;color:white;border:1px solid rgba(255,255,255,0.12)}
  .btn.full{background:var(--blue-dark);color:white}
  main.main{flex:1;padding:22px}
  header.main-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
  .header-left h1{margin:0;color:var(--blue);font-size:26px}
  .muted{color:var(--muted)}
  .controls{display:flex;gap:12px;align-items:center}
  input.search{padding:9px;border-radius:10px;border:1px solid #e6e9f2;min-width:220px}

  /* folder grid */
  .folder-grid{display:flex;flex-wrap:wrap;gap:18px;margin-top:18px}
  .folder-card{width:210px;border-radius:12px;padding:16px;background:var(--card);box-shadow:0 6px 18px rgba(9,30,66,0.06);cursor:pointer;transition:transform .15s,box-shadow .15s}
  .folder-card:hover{transform:translateY(-6px);box-shadow:0 18px 32px rgba(9,30,66,0.08)}
  .folder-icon{font-size:34px;color:var(--blue)}
  .folder-name{font-weight:800;color:#092240;margin-top:6px}
  .folder-meta{color:var(--muted);font-size:13px}

  /* folder view */
  .folder-section{display:none;margin-top:16px}
  .folder-view{display:flex;gap:20px}
  .left{width:420px;display:flex;flex-direction:column;gap:12px}
  .controls-row{display:flex;gap:8px}
  .card-list{display:flex;flex-direction:column;gap:12px;max-height:65vh;overflow:auto;padding-right:8px}
  .card-row{display:flex;justify-content:space-between;gap:12px;align-items:center;padding:12px;border-radius:10px;background:var(--card);box-shadow:0 6px 14px rgba(9,30,66,0.04)}
  .term{font-weight:700;color:var(--blue-dark)}
  .def{color:var(--muted);font-size:14px;max-width:240px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .card-actions{display:flex;gap:8px;align-items:center}
  .icon-btn{border:none;background:transparent;cursor:pointer;font-size:16px;padding:8px;border-radius:8px}
  .icon-btn:hover{background:rgba(9,30,66,0.04)}

  /* study area */
  .study-area{flex:1;display:flex;flex-direction:column;align-items:center;gap:16px;justify-content:flex-start;padding-top:30px}
  .big-card{width:540px;height:320px;border-radius:var(--radius);background:var(--card);box-shadow:0 18px 36px rgba(9,30,66,0.08);display:flex;align-items:center;justify-content:center;font-size:28px;padding:24px;perspective:1000px;cursor:pointer;position:relative}
  .inner{width:100%;height:100%;border-radius:var(--radius);transition:transform .7s;transform-style:preserve-3d;position:relative}
  .big-card.flip .inner{transform:rotateY(180deg)}
  .face{position:absolute;inset:0;backface-visibility:hidden;display:flex;align-items:center;justify-content:center;padding:28px;border-radius:var(--radius);box-sizing:border-box;text-align:center}
  .front{color:var(--blue-dark);font-weight:700}
  .back{transform:rotateY(180deg);background:var(--blue);color:white;font-weight:700}

  .study-controls{display:flex;gap:10px;align-items:center;margin-top:6px}
  .know{background:var(--success);color:white;padding:12px 18px;border-radius:10px;border:none;cursor:pointer}
  .dont{background:var(--danger);color:white;padding:12px 18px;border-radius:10px;border:none;cursor:pointer}
  .mode-toggle{background:transparent;border:1px solid rgba(9,30,66,0.08);padding:8px 10px;border-radius:8px;cursor:pointer}

  /* test */
  .test-area{width:640px;background:var(--card);border-radius:12px;padding:18px;box-shadow:0 12px 28px rgba(9,30,66,0.06)}
  .mc-question{font-size:20px;margin-bottom:12px}
  .mc-options{display:flex;flex-direction:column;gap:8px}
  .mc-option{padding:12px 14px;border-radius:10px;border:1px solid #e6e9f2;cursor:pointer;background:white}
  .mc-option.correct{background:linear-gradient(90deg, rgba(40,167,69,0.12), rgba(40,167,69,0.06));border-color:#c1f0d0}
  .mc-option.incorrect{background:linear-gradient(90deg, rgba(220,53,69,0.08), rgba(220,53,69,0.03));border-color:#f2c7c9}

  /* game */
  .game-area{display:flex;flex-direction:column;align-items:center;gap:8px}
  .game-frame-wrap{position:relative;width:860px;height:540px;border-radius:10px;overflow:hidden;background:#000}
  .game-iframe{width:100%;height:100%;border:0}
  .game-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
  .game-blocker{position:absolute;inset:0;background:rgba(255,255,255,0.0001); /* invisible but captures events */ display:none; z-index:40}
  .timer-bubble{position:absolute;top:12px;right:12px;background:linear-gradient(90deg,var(--yellow),#ffd24b);padding:8px 12px;border-radius:999px;font-weight:800;z-index:50}
  .game-controls{display:flex;gap:8px;align-items:center;margin-top:8px}

  /* modal */
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(7,14,28,0.36);z-index:80}
  .modal.open{display:grid}
  .modal-box{width:560px;background:white;border-radius:12px;padding:16px;box-shadow:0 30px 80px rgba(9,30,66,0.2)}
  textarea,input{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9f2;font-size:14px}

  /* small */
  .muted2{color:#8b94a6;font-size:13px}
  .footer-hint{margin-top:12px;color:var(--muted);font-size:13px}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="logo"><span class="ball">üèÄ</span> Steph Study</div>
    <div class="small">Study faster ‚Äî play harder</div>

    <button class="btn create" onclick="openCreateModal()">+ New Folder</button>
    <button class="btn ghost" onclick="renderFolderList()">Folders</button>

    <div style="flex:1"></div>

    <button class="btn full" onclick="exportData()">Export (JSON)</button>
    <button class="btn ghost" onclick="importModal()">Import (JSON)</button>
    <div class="small muted" style="margin-top:10px">Saved in browser (localStorage)</div>
  </aside>

  <main class="main">
    <header class="main-header">
      <div class="header-left">
        <h1>Steph Study</h1>
        <p class="muted">Blue + yellow ‚Äî flip, sort, test, edit, play</p>
      </div>

      <div class="controls">
        <input id="search" class="search" placeholder="Search folders or cards..." oninput="applySearch()" />
        <div class="muted2">Shortcuts: ‚Üê ‚Üí | F flip | K know | D don't | T test | G game</div>
      </div>
    </header>

    <!-- folder grid -->
    <section id="grid">
      <div class="folder-grid" id="folderGrid"></div>
    </section>

    <!-- folder section -->
    <section class="folder-section" id="folderSection">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:800;font-size:18px" id="folderTitleLabel"></div>
          <div class="muted" id="folderCountLabel"></div>
        </div>
        <div>
          <button class="icon-btn" title="Edit folder" onclick="openEditFolderModal()">‚úèÔ∏è</button>
          <button class="icon-btn" title="Delete folder" onclick="deleteFolderConfirm()">üóëÔ∏è</button>
        </div>
      </div>

      <div style="display:flex;gap:18px;margin-top:12px">
        <div class="left">
          <div style="display:flex;gap:8px">
            <button class="btn full" onclick="openAddCardModal()">+ Add Card</button>
            <button class="btn" style="background:var(--yellow);color:var(--blue);font-weight:800" onclick="openBulkModal()">Bulk Add</button>
            <button class="btn" onclick="startStudyMode('regular')">Study (Flip)</button>
            <button class="btn" onclick="startStudyMode('sorting')">Study (Sort)</button>
            <button class="btn" onclick="startTestMode()">Test</button>
            <button class="btn" onclick="openGamePanel()">Game</button>
          </div>

          <div style="margin-top:12px">
            <div class="card-list" id="cardList"></div>
          </div>
        </div>

        <div class="study-area" id="studyArea" style="width:100%">
          <div style="text-align:center;color:var(--muted);margin-top:40px">Open a folder and choose Study, Test, or Game to begin</div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Modals -->
<div id="modal" class="modal"><div class="modal-box" id="modalBox"></div></div>

<!-- hidden file input for folder image -->
<input id="folderImageInput" type="file" accept="image/*" style="display:none" />

<script>
/* ---------------------------
   Data model & persistence
   --------------------------- */
let data = JSON.parse(localStorage.getItem('steph_study_data') || '{}');
// folder structure: data = { folderName: [ {id, term, def, img?}, ... ], ... }
// folderMeta: saved as property on folder object? We'll store image as folder meta map.
let folderMeta = JSON.parse(localStorage.getItem('steph_study_meta') || '{}'); // { folderName: { image: dataURL } }

function saveAll(){
  localStorage.setItem('steph_study_data', JSON.stringify(data));
  localStorage.setItem('steph_study_meta', JSON.stringify(folderMeta));
}

/* ---------------------------
   helpers
   --------------------------- */
function uid(){ return Math.random().toString(36).slice(2,10) }
function escapeHtml(str){ return String(str||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;') }
function shuffle(arr){ const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }

/* ---------------------------
   rendering folders
   --------------------------- */
const folderGrid = document.getElementById('folderGrid');
const folderSection = document.getElementById('folderSection');
const folderTitleLabel = document.getElementById('folderTitleLabel');
const folderCountLabel = document.getElementById('folderCountLabel');
const cardList = document.getElementById('cardList');
const studyArea = document.getElementById('studyArea');
let currentFolder = null;

function renderFolderList(filter=''){
  folderSection.style.display='none';
  document.getElementById('grid').style.display='block';
  folderGrid.innerHTML='';
  const names = Object.keys(data).filter(n => n.toLowerCase().includes(filter.toLowerCase()));
  if(names.length===0){
    folderGrid.innerHTML = `<div style="color:var(--muted);padding:20px">No folders yet ‚Äî create one.</div>`;
    return;
  }
  names.forEach(name=>{
    const meta = folderMeta[name] || {};
    const el = document.createElement('div'); el.className='folder-card';
    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="display:flex;gap:12px;align-items:center">
          <div class="folder-icon">${meta.image ? `<img src="${meta.image}" alt="img" style="width:46px;height:46px;border-radius:8px;object-fit:cover;border:2px solid #fff"/>` : 'üìÅ'}</div>
          <div>
            <div class="folder-name">${escapeHtml(name)}</div>
            <div class="folder-meta">${data[name].length} cards</div>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button class="icon-btn" title="Open" onclick="openFolder('${encodeURIComponent(name)}')">‚ñ∂Ô∏è</button>
        </div>
      </div>`;
    folderGrid.appendChild(el);
  });
}

/* ---------------------------
   open folder & card list
   --------------------------- */
function openFolder(encodedName){
  const name = decodeURIComponent(encodedName);
  currentFolder = name;
  document.getElementById('grid').style.display='none';
  folderSection.style.display='block';
  folderTitleLabel.textContent = name;
  folderCountLabel.textContent = `${data[name].length} cards`;
  renderCardList();
  studyArea.innerHTML = `<div style="text-align:center;color:var(--muted);margin-top:40px">Choose Study, Test or Game to begin</div>`;
}

function renderCardList(){
  cardList.innerHTML='';
  const arr = data[currentFolder] || [];
  if(arr.length===0){ cardList.innerHTML = `<div style="color:var(--muted);padding:10px">No cards ‚Äî add one or bulk add.</div>`; return; }
  arr.forEach(card=>{
    const row = document.createElement('div'); row.className='card-row';
    row.innerHTML = `<div>
        <div class="term">${escapeHtml(card.term)}</div>
        <div class="def">${escapeHtml(card.def)}</div>
      </div>
      <div class="card-actions">
        <button class="icon-btn" title="Edit" onclick="openEditCardModal('${card.id}')">‚úèÔ∏è</button>
        <button class="icon-btn" title="Delete" onclick="deleteCardConfirm('${card.id}')">üóëÔ∏è</button>
      </div>`;
    cardList.appendChild(row);
  });
}

/* ---------------------------
   create/edit modals
   --------------------------- */
const modal = document.getElementById('modal');
const modalBox = document.getElementById('modalBox');

function openCreateModal(){
  modalBox.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Create Folder</h3>
      <button onclick="closeModal()" class="icon-btn">‚úñÔ∏è</button>
    </div>
    <div style="margin-top:12px">
      <input id="newFolderName" placeholder="Folder name" />
      <div style="margin-top:8px;display:flex;gap:8px">
        <button onclick="selectFolderImage()" class="btn" style="flex:1">Add Image</button>
        <button onclick="removeFolderImageTemp()" class="btn ghost">Remove Image</button>
      </div>
      <div id="newFolderImgPreview" style="margin-top:8px"></div>
      <textarea id="newBulk" style="height:110px;margin-top:8px" placeholder="Bulk add (term - definition per line)"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="save-btn" onclick="createFolder()">Create</button>
        <button class="btn" onclick="closeModal()">Cancel</button>
      </div>
    </div>`;
  modal.classList.add('open');
  // prepare temp holder
  modal.tempImage = null;
}

function selectFolderImage(){
  const fi = document.getElementById('folderImageInput');
  fi.onchange = function(e){
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(ev){
      modal.tempImage = ev.target.result;
      const p = document.getElementById('newFolderImgPreview');
      p.innerHTML = `<img src="${modal.tempImage}" style="max-width:100%;border-radius:8px"/>`;
    };
    reader.readAsDataURL(file);
  };
  fi.click();
}
function removeFolderImageTemp(){
  modal.tempImage = null;
  const p = document.getElementById('newFolderImgPreview');
  if(p) p.innerHTML = '';
}

function createFolder(){
  const name = document.getElementById('newFolderName').value.trim();
  if(!name) return alert('Folder name required');
  if(data[name]) return alert('Folder exists');
  data[name] = [];
  if(modal.tempImage) folderMeta[name] = { image: modal.tempImage };
  const bulk = document.getElementById('newBulk').value.trim();
  if(bulk){
    bulk.split('\n').forEach(line => {
      if(!line.includes('-')) return;
      const parts = line.split('-'); const term = parts.shift().trim(); const def = parts.join('-').trim();
      if(term && def) data[name].push({ id:uid(), term, def });
    });
  }
  saveAll(); closeModal(); renderFolderList();
}

function openEditFolderModal(){
  modalBox.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Edit Folder</h3>
      <button onclick="closeModal()" class="icon-btn">‚úñÔ∏è</button>
    </div>
    <div style="margin-top:12px">
      <input id="editFolderName" value="${escapeHtml(currentFolder)}" />
      <div style="margin-top:8px;display:flex;gap:8px">
        <button onclick="selectEditFolderImage()" class="btn" style="flex:1">Change Image</button>
        <button onclick="removeEditFolderImage()" class="btn ghost">Remove Image</button>
      </div>
      <div id="editFolderImgPreview" style="margin-top:8px">${folderMeta[currentFolder] && folderMeta[currentFolder].image ? `<img src="${folderMeta[currentFolder].image}" style="max-width:100%;border-radius:8px"/>` : ''}</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="save-btn" onclick="saveEditedFolder()">Save</button>
        <button class="btn" onclick="closeModal()">Cancel</button>
      </div>
    </div>`;
  modal.classList.add('open');
  modal.tempImage = folderMeta[currentFolder] ? folderMeta[currentFolder].image : null;
}
function selectEditFolderImage(){
  const fi = document.getElementById('folderImageInput');
  fi.onchange = function(e){
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(ev){
      modal.tempImage = ev.target.result;
      const p = document.getElementById('editFolderImgPreview');
      p.innerHTML = `<img src="${modal.tempImage}" style="max-width:100%;border-radius:8px"/>`;
    };
    reader.readAsDataURL(file);
  };
  fi.click();
}
function removeEditFolderImage(){
  modal.tempImage = null;
  const p = document.getElementById('editFolderImgPreview'); if(p) p.innerHTML = '';
}

function saveEditedFolder(){
  const newName = document.getElementById('editFolderName').value.trim();
  if(!newName) return alert('Name required');
  if(newName !== currentFolder && data[newName]) return alert('Name taken');
  // rename data
  if(newName !== currentFolder){
    data[newName] = data[currentFolder];
    delete data[currentFolder];
    if(folderMeta[currentFolder]) folderMeta[newName] = folderMeta[currentFolder];
    delete folderMeta[currentFolder];
    currentFolder = newName;
  }
  if(modal.tempImage) folderMeta[currentFolder] = { image: modal.tempImage };
  else delete folderMeta[currentFolder];
  saveAll(); closeModal(); openFolder(encodeURIComponent(currentFolder));
}

function closeModal(){ modal.classList.remove('open'); modalBox.innerHTML=''; modal.tempImage=null; document.getElementById('folderImageInput').value=''; }

/* ---------------------------
   card add/edit/delete
   --------------------------- */
function openAddCardModal(){
  modalBox.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Add Card to "${escapeHtml(currentFolder)}"</h3>
      <button onclick="closeModal()" class="icon-btn">‚úñÔ∏è</button>
    </div>
    <div style="margin-top:12px">
      <input id="addTerm" placeholder="Term" />
      <textarea id="addDef" style="height:120px" placeholder="Definition"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="save-btn" onclick="addCard()">Add Card</button>
        <button class="btn" onclick="closeModal()">Cancel</button>
      </div>
    </div>`;
  modal.classList.add('open');
}
function addCard(){
  const term = document.getElementById('addTerm').value.trim();
  const def = document.getElementById('addDef').value.trim();
  if(!term || !def) return alert('Enter term and definition');
  data[currentFolder].push({ id:uid(), term, def }); saveAll(); closeModal(); renderCardList(); folderCountLabel.textContent = `${data[currentFolder].length} cards`;
}
function openEditCardModal(cardId){
  const card = (data[currentFolder]||[]).find(c=>c.id===cardId); if(!card) return alert('Card not found');
  modalBox.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Edit Card</h3>
      <button onclick="closeModal()" class="icon-btn">‚úñÔ∏è</button>
    </div>
    <div style="margin-top:12px">
      <input id="editTerm" value="${escapeHtml(card.term)}" />
      <textarea id="editDef" style="height:120px">${escapeHtml(card.def)}</textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="save-btn" onclick="saveEditedCard('${cardId}')">Save</button>
        <button class="btn" onclick="closeModal()">Cancel</button>
      </div>
    </div>`;
  modal.classList.add('open');
}
function saveEditedCard(cardId){
  const term = document.getElementById('editTerm').value.trim();
  const def = document.getElementById('editDef').value.trim();
  if(!term || !def) return alert('Enter both fields');
  const idx = data[currentFolder].findIndex(c=>c.id===cardId);
  if(idx>=0){ data[currentFolder][idx].term = term; data[currentFolder][idx].def = def; saveAll(); closeModal(); renderCardList(); }
}
function deleteCardConfirm(cardId){
  if(!confirm('Delete this card?')) return;
  data[currentFolder] = data[currentFolder].filter(c=>c.id !== cardId); saveAll(); renderCardList(); folderCountLabel.textContent = `${data[currentFolder].length} cards`;
}
function deleteFolderConfirm(){
  if(!confirm(`Delete folder "${currentFolder}"? This cannot be undone.`)) return;
  delete data[currentFolder]; delete folderMeta[currentFolder]; saveAll(); currentFolder=null; renderFolderList();
}

/* ---------------------------
   bulk add
   --------------------------- */
function openBulkModal(){
  modalBox.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Bulk Add to "${escapeHtml(currentFolder)}"</h3>
      <button onclick="closeModal()" class="icon-btn">‚úñÔ∏è</button>
    </div>
    <div style="margin-top:12px">
      <textarea id="bulkToFolder" style="height:160px" placeholder="term - definition per line"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="save-btn" onclick="bulkAddToCurrent()">Add</button>
        <button class="btn" onclick="closeModal()">Cancel</button>
      </div>
    </div>`;
  modal.classList.add('open');
}
function bulkAddToCurrent(){
  const txt = document.getElementById('bulkToFolder').value.trim(); if(!txt) return alert('Bulk text required');
  txt.split('\n').forEach(line=>{
    if(!line.includes('-')) return;
    const parts = line.split('-'); const term = parts.shift().trim(); const def = parts.join('-').trim();
    if(term && def) data[currentFolder].push({ id:uid(), term, def });
  });
  saveAll(); closeModal(); renderCardList(); folderCountLabel.textContent = `${data[currentFolder].length} cards`;
}

/* ---------------------------
   search
   --------------------------- */
function applySearch(){
  const q = document.getElementById('search').value.trim();
  if(folderSection.style.display==='block'){
    const arr = (data[currentFolder]||[]).filter(c=>c.term.toLowerCase().includes(q.toLowerCase()) || c.def.toLowerCase().includes(q.toLowerCase()));
    cardList.innerHTML=''; if(arr.length===0) cardList.innerHTML=`<div style="color:var(--muted);padding:10px">No cards matching.</div>`;
    arr.forEach(c=>{ const row=document.createElement('div'); row.className='card-row'; row.innerHTML = `<div><div class="term">${escapeHtml(c.term)}</div><div class="def">${escapeHtml(c.def)}</div></div><div class="card-actions"><button class="icon-btn" title="Edit" onclick="openEditCardModal('${c.id}')">‚úèÔ∏è</button><button class="icon-btn" title="Delete" onclick="deleteCardConfirm('${c.id}')">üóëÔ∏è</button></div>`; cardList.appendChild(row); });
  } else { renderFolderList(q); }
}

/* ---------------------------
   Study modes
   --------------------------- */
let studyState = null; // { mode, queue, index, known, unknown, flipped }
function startStudyMode(mode){
  if(!currentFolder) return alert('Open a folder first');
  const pool = (data[currentFolder]||[]).map(c=>({...c})); if(pool.length===0) return alert('Folder empty');
  studyState = { mode, queue: shuffle(pool), index:0, known:[], unknown:[], flipped:false };
  renderStudyUI();
}
function renderStudyUI(){
  studyArea.innerHTML = `
    <div style="display:flex;justify-content:space-between;width:100%;max-width:900px;align-items:center">
      <div><strong>${escapeHtml(currentFolder)}</strong> ‚Äî <span class="muted">${studyState.queue.length} cards</span></div>
      <div class="toolbar">
        <div class="muted2">Mode: <strong>${studyState.mode}</strong></div>
        <div style="width:12px"></div>
        <button class="mode-toggle" onclick="endStudy()">End</button>
      </div>
    </div>
    <div class="big-card" id="bigCard" onclick="flipStudyCard()" title="Click or press F to flip">
      <div class="inner" id="innerCard">
        <div class="face front" id="studyFront"></div>
        <div class="face back" id="studyBack"></div>
      </div>
    </div>
    <div style="display:flex;gap:12px;align-items:center">
      <button class="know" onclick="markKnow()">Know (K)</button>
      <button class="dont" onclick="markDont()">Don't Know (D)</button>
      <div style="margin-left:12px" id="progressLabel"></div>
    </div>`;
  updateStudyCard();
  // enable keyboard listener scope
  studyKeyEnabled = true;
}
function updateStudyCard(){
  if(!studyState) return;
  if(studyState.index >= studyState.queue.length){
    studyArea.innerHTML = `<div style="text-align:center;max-width:760px"><h2>Session Complete</h2><p class="muted">${studyState.known.length} known ‚Äî ${studyState.unknown.length} didn't know (re-queued)</p><div style="display:flex;gap:10px;justify-content:center;margin-top:12px"><button class="save-btn" onclick="endStudy()">Close</button></div></div>`;
    studyKeyEnabled = false;
    return;
  }
  const card = studyState.queue[studyState.index];
  document.getElementById('studyFront').textContent = card.term;
  document.getElementById('studyBack').textContent = card.def;
  document.getElementById('progressLabel').textContent = `Card ${studyState.index+1} / ${studyState.queue.length}`;
  document.getElementById('bigCard').classList.remove('flip');
}
function flipStudyCard(){ if(!studyState) return; document.getElementById('bigCard').classList.toggle('flip'); }
function markKnow(){ if(!studyState) return; const card = studyState.queue[studyState.index]; studyState.known.push(card); studyState.index++; updateStudyCard(); }
function markDont(){ if(!studyState) return; const card = studyState.queue[studyState.index]; studyState.unknown.push(card); studyState.queue.push(card); studyState.index++; updateStudyCard(); }
function endStudy(){ studyState=null; studyArea.innerHTML=`<div style="text-align:center;color:var(--muted);margin-top:40px">Choose Study, Test or Game to begin</div>`; studyKeyEnabled=false; }

/* keyboard support for study */
let studyKeyEnabled = false;
document.addEventListener('keydown', e=>{
  if(e.key === 'ArrowLeft') { if(inTest) prevTestQuestion(); else prevStudyCard(); }
  if(e.key === 'ArrowRight') { if(inTest) nextTestQuestion(); else nextStudyCard(); }
  if(e.key.toLowerCase() === 'f') flipShortcut();
  if(e.key.toLowerCase() === 'k') { if(studyKeyEnabled) markKnow(); }
  if(e.key.toLowerCase() === 'd') { if(studyKeyEnabled) markDont(); }
  if(e.key.toLowerCase() === 't') { if(currentFolder) startTestMode(); }
  if(e.key.toLowerCase() === 'g') { if(currentFolder) openGamePanel(); }
});

function prevStudyCard(){ if(studyState && studyState.index>0){ studyState.index--; updateStudyCard(); } }
function nextStudyCard(){ if(studyState && studyState.index < studyState.queue.length-1){ studyState.index++; updateStudyCard(); } }
function flipShortcut(){ if(studyState) flipStudyCard(); }

/* ---------------------------
   Test Mode
   --------------------------- */
let testState = null;
let inTest = false;
function startTestMode(){
  if(!currentFolder) return alert('Open a folder first');
  const pool = data[currentFolder].slice(); if(pool.length < 2) return alert('Need >=2 cards for test');
  testState = { pool: shuffle(pool), index:0, score:0, total: Math.min(10, pool.length) }; inTest = true; renderTestUI();
}
function renderTestUI(){
  studyArea.innerHTML = `
    <div style="width:100%;max-width:760px;display:flex;justify-content:space-between;align-items:center">
      <div><strong>Test: ${escapeHtml(currentFolder)}</strong> ‚Äî Question ${testState.index+1}/${testState.total}</div>
      <div><button class="mode-toggle" onclick="endTest()">End Test</button></div>
    </div>
    <div class="test-area" id="testArea"></div>`;
  showTestQuestion();
}
function showTestQuestion(){
  const idx = testState.index;
  if(idx >= testState.total){ studyArea.innerHTML = `<div style="text-align:center;max-width:760px"><h2>Test Complete</h2><p class="muted">Score: ${testState.score} / ${testState.total}</p><div style="display:flex;gap:10px;justify-content:center;margin-top:12px"><button class="save-btn" onclick="endTest()">Close</button></div></div>`; inTest=false; return; }
  const question = testState.pool[idx];
  const others = data[currentFolder].filter(c=>c.id !== question.id);
  const distractors = shuffle(others).slice(0,3).map(d=>d.def);
  const options = shuffle([question.def, ...distractors]);
  const testAreaEl = document.getElementById('testArea');
  testAreaEl.innerHTML = `
    <div class="mc-question">What is the definition of:<br><strong style="font-size:20px">${escapeHtml(question.term)}</strong></div>
    <div class="mc-options" id="mcOptions">
      ${options.map((o,i)=>`<div class="mc-option" data-val="${escapeHtml(o)}" onclick="chooseOption(${i})">${escapeHtml(o)}</div>`).join('')}
    </div>`;
  testState.currentCorrect = question.def; testState.currentOptions = options;
}
function chooseOption(i){
  const opts = document.querySelectorAll('.mc-option');
  const selected = testState.currentOptions[i];
  opts.forEach(o=>{
    const v = o.getAttribute('data-val');
    if(v === testState.currentCorrect) o.classList.add('correct');
    if(v === selected && v !== testState.currentCorrect) o.classList.add('incorrect');
    o.style.pointerEvents='none';
  });
  if(selected === testState.currentCorrect) testState.score++;
  setTimeout(()=>{ testState.index++; showTestQuestion(); }, 800);
}
function endTest(){ testState=null; inTest=false; studyArea.innerHTML=`<div style="text-align:center;color:var(--muted);margin-top:40px">Choose Study, Test or Game to begin</div>`; }

/* keyboard test navigation helper (simple) */
function prevTestQuestion(){ if(inTest && testState && testState.index>0){ testState.index--; showTestQuestion(); } }
function nextTestQuestion(){ if(inTest && testState && testState.index < testState.total-1){ testState.index++; showTestQuestion(); } }

/* ---------------------------
   Game Mode (BasketBros embed + Q/A flow)
   --------------------------- */
let gameState = null; // { playing:bool, timer, remaining, intervalId, locked:boolean, currentQuestion, iframeLoaded }
const GAME_URL = 'https://basketbros.bitbucket.io';
function openGamePanel(){
  if(!currentFolder) return alert('Open a folder first');
  const html = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>BasketBros Challenge ‚Äî Folder: ${escapeHtml(currentFolder)}</strong></div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="muted2" style="font-size:13px">You play 10s, then answer a question. Correct => +10s</div>
        <button class="mode-toggle" onclick="closeGamePanel()">Close</button>
      </div>
    </div>
    <div class="game-area" style="margin-top:12px">
      <div class="timer-bubble" id="gameTimer">‚Äî</div>
      <div class="game-frame-wrap" id="gameWrap">
        <iframe id="gameIframe" class="game-iframe" src="${GAME_URL}" sandbox="allow-scripts allow-same-origin allow-forms" ></iframe>
        <div id="gameBlocker" class="game-blocker"></div>
      </div>
      <div class="game-controls">
        <button class="btn full" onclick="startGameSession()">Start Challenge (G)</button>
        <button class="btn" onclick="openGameInNewTab()">Open Game in New Tab</button>
      </div>
      <div style="margin-top:8px; color:var(--muted); font-size:13px">If the game does not appear it might block being embedded. Use "Open Game in New Tab".</div>
      <div id="gameQuestionArea" style="margin-top:8px"></div>
    </div>`;
  studyArea.innerHTML = html;
  gameState = { playing:false, timer:10, remaining:10, intervalId:null, locked:false, currentQuestion:null, iframeLoaded:false };
  // detect iframe load/errors
  const iframe = document.getElementById('gameIframe');
  iframe.addEventListener('load', ()=>{ gameState.iframeLoaded = true; });
}
function openGameInNewTab(){ window.open(GAME_URL, '_blank'); }
function closeGamePanel(){ stopGameSession(); studyArea.innerHTML=`<div style="text-align:center;color:var(--muted);margin-top:40px">Choose Study, Test or Game to begin</div>`; }

// overlay blocker toggle
function setGameBlocker(state){
  const blocker = document.getElementById('gameBlocker');
  if(!blocker) return;
  blocker.style.display = state ? 'block' : 'none';
  // when blocked, also disable keyboard shortcuts for study/test
  gameState.locked = !!state;
  keyboardInputAllowed = !state;
}

// start/stop
function startGameSession(){
  if(!currentFolder) return alert('Open a folder first');
  if(!data[currentFolder] || data[currentFolder].length===0) return alert('Folder empty');
  // reset
  gameState.playing = true; gameState.remaining = 10; updateGameTimer();
  setGameBlocker(false);
  // start timer countdown visible
  if(gameState.intervalId) clearInterval(gameState.intervalId);
  gameState.intervalId = setInterval(()=>{
    gameState.remaining--;
    updateGameTimer();
    if(gameState.remaining <= 0){ // time's up -> present question
      clearInterval(gameState.intervalId); gameState.intervalId = null;
      presentGameQuestion();
    }
  }, 1000);
}

// update timer UI
function updateGameTimer(){
  const el = document.getElementById('gameTimer');
  if(el) el.textContent = `${gameState.remaining}s`;
}

// present question: block game input and show a multiple-choice question
function presentGameQuestion(){
  setGameBlocker(true); // block iframe controls
  // choose a random card as question
  const pool = data[currentFolder].slice();
  const q = pool[Math.floor(Math.random()*pool.length)];
  // choose distractors
  const others = pool.filter(c=>c.id !== q.id);
  const distractors = shuffle(others).slice(0,3).map(d=>d.def);
  const options = shuffle([q.def, ...distractors]);
  gameState.currentQuestion = { card:q, options, correct:q.def };
  // render question UI
  const qa = document.getElementById('gameQuestionArea');
  qa.innerHTML = `
    <div style="width:760px;background:var(--card);padding:12px;border-radius:12px;box-shadow:0 12px 28px rgba(9,30,66,0.06)">
      <div style="font-weight:700;margin-bottom:8px">Answer to keep playing:</div>
      <div style="margin-bottom:8px">What is the definition of <strong>${escapeHtml(q.term)}</strong>?</div>
      <div style="display:flex;flex-direction:column;gap:8px" id="gameOptions">
        ${options.map((o,i)=>`<button class="mc-option" onclick="answerGameQuestion(${i})" data-val="${escapeHtml(o)}">${escapeHtml(o)}</button>`).join('')}
      </div>
    </div>`;
  // temporarily disable global keyboard for study/test
  keyboardInputAllowed = false;
}

// answerGameQuestion
function answerGameQuestion(i){
  const chosen = gameState.currentQuestion.options[i];
  const correct = gameState.currentQuestion.correct;
  const opts = document.querySelectorAll('#gameOptions .mc-option');
  opts.forEach(btn=>{
    const v = btn.getAttribute('data-val');
    if(v === correct) btn.style.borderColor = 'green';
    if(v === chosen && v !== correct) btn.style.borderColor = 'red';
    btn.disabled = true;
  });
  // check correctness
  if(chosen === correct){
    // correct: resume play for another 10 seconds
    const qa = document.getElementById('gameQuestionArea');
    if(qa) qa.innerHTML = `<div style="padding:10px;color:green;font-weight:700">Correct ‚Äî resume play! +10s</div>`;
    // resume: unblock, reset timer
    setTimeout(()=>{ setGameBlocker(false); gameState.remaining = 10; updateGameTimer(); gameState.intervalId = setInterval(()=>{ gameState.remaining--; updateGameTimer(); if(gameState.remaining<=0){ clearInterval(gameState.intervalId); gameState.intervalId=null; presentGameQuestion(); } },1000); document.getElementById('gameQuestionArea').innerHTML=''; keyboardInputAllowed = true; }, 900);
  } else {
    // wrong: game stays blocked; show fail and option to end
    const qa = document.getElementById('gameQuestionArea');
    if(qa) qa.innerHTML = `<div style="padding:10px;color:var(--danger);font-weight:700">Incorrect ‚Äî game over. Study more and try again.</div><div style="margin-top:8px"><button class="btn" onclick="closeGamePanel()">Close</button></div>`;
    // keep blocked; clear any timers
    if(gameState.intervalId) { clearInterval(gameState.intervalId); gameState.intervalId = null; }
    gameState.playing = false;
  }
}

function stopGameSession(){ if(gameState && gameState.intervalId) { clearInterval(gameState.intervalId); gameState.intervalId = null; } if(document.getElementById('gameBlocker')) document.getElementById('gameBlocker').style.display='none'; keyboardInputAllowed = true; gameState = null; }

/* ---------------------------
   Keyboard global guard
   --------------------------- */
let keyboardInputAllowed = true; // disabled while answering game questions
// guard certain shortcuts when keyboard input not allowed
document.addEventListener('keydown', e=>{
  if(!keyboardInputAllowed) return;
  // already handled study-specific earlier: we check studyKeyEnabled etc.
});

/* ---------------------------
   Import / Export JSON
   --------------------------- */
function exportData(){
  const all = { data, meta: folderMeta };
  const blob = new Blob([JSON.stringify(all, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'steph_study_backup.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function importModal(){
  modalBox.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center"><h3 style="margin:0">Import JSON</h3><button onclick="closeModal()" class="icon-btn">‚úñÔ∏è</button></div>
    <div style="margin-top:12px"><input type="file" id="importFile" accept="application/json" /><div style="display:flex;gap:8px;margin-top:8px"><button class="save-btn" onclick="doImport()">Import</button><button class="btn" onclick="closeModal()">Cancel</button></div></div>
  `;
  modal.classList.add('open');
}
function doImport(){
  const file = document.getElementById('importFile').files[0]; if(!file) return alert('Select a file');
  const reader = new FileReader();
  reader.onload = function(e){
    try{
      const obj = JSON.parse(e.target.result);
      if(obj.data) data = obj.data;
      if(obj.meta) folderMeta = obj.meta;
      saveAll(); closeModal(); renderFolderList(); alert('Imported');
    } catch(err){ alert('Invalid file'); }
  };
  reader.readAsText(file);
}

/* ---------------------------
   init sample if empty
   --------------------------- */
if(Object.keys(data).length === 0){
  data['Sample: Basketball'] = [
    { id: uid(), term: 'Dribble', def: 'Bounce the ball while moving.' },
    { id: uid(), term: 'Assist', def: 'A pass that leads directly to a score.' },
    { id: uid(), term: 'Rebound', def: 'Retrieve the ball after a missed shot.' },
  ];
  saveAll();
}

/* ---------------------------
   safety: close modal on background click
   --------------------------- */
modal.addEventListener('click', e => { if(e.target === modal) closeModal(); });

/* ---------------------------
   initial render
   --------------------------- */
renderFolderList();

/* ---------------------------
   Note about iframe embedding
   --------------------------- */
/*
  Many sites set headers that prevent embedding in an iframe (X-Frame-Options).
  If the BasketBros game refuses to load in the iframe, use "Open Game in New Tab".
  The app uses 'sandbox' attribute on the iframe to keep it isolated (allow-scripts, allow-same-origin, allow-forms).
*/

</script>
</body>
</html>
